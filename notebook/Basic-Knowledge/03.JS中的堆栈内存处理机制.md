## JavaScript中的堆栈内存处理机制

### JS内存生命周期

内存管理是每一种编程语言都会具备的一种基本能力

区别在于，一些语言会将这种能力开放——比如C语言中的`malloc()`和`free()`方法，这些方法的暴露，使得开发者能够切身感受到内存管理这件事的存在。

而在另一些语言——比如JS中，这种能力是被“隐藏“了的：JS并没有暴露任何内存操作给开发者，而是自己默默地自动完成了所有的管理动作。这是JS内存管理不被大多数同学所重视的原因。

JS的内存生命周期，和大多数编程语言一样，分为三个阶段。这三个阶段非常好理解，跟农民种地的过程差不多：

```mermaid
graph LR
A(挖坑) -->B(填坑)-->C(还坑)
 
```

- ”挖坑“——在内存空间这片广袤无垠的沃土里，划出自己的一亩三分地，此举称为`内存分配`。
- ”用坑“——往你的一亩三分地里”种菜“：塞入你需要存储的信息。此后你可以读取它，也可以更改它，此举称为”内存的读与写“操作。
- ”还坑“——用坑一时爽，但作为好公民，咱们用完这个地就得及时上交村里。这个”还回去“的动作，就叫内存的释放。

如此一来呢，想必大家都对这个”种地“一般的声明周期流程心知肚明了。但是，光知道流程，你还未必能种出好果子。要想奔小康，你还得知道这”挖坑“阶段里头的另一层门道——不同的果子（数据），它喜欢不同的土壤，咱们必须从每一种”果子“的类型和特性出发，为它开辟不同类型的内存空间。



### JS代码的执行过程

首先我们先来看一道简单的面试题

```javascript
var a = 12
var b = a
b = 13
console.log(a)
```

我们很容易得出结果为12。那么我们来探究下这段代码的执行过程：

- 第一步：浏览器会在计算机内存中「内存条」开辟一块内存，专门用来执行JS代码，我们称它为**栈内存**：执行环境栈ECStack「Execution Context Stack」
- 第二步：开辟一个**全局执行上下文**EC(G)-->Execution Context(Global)，用来供全局代码执行；那么为什么要形成一个上下文呢？其实是为了能够区分不同区域代码的执行
- 第三步：在全局上下文下，会有一个单独的区域专门存放声明的变量叫**全局变量对象**VO(G)=>Variable Object(Global)
- 第四步：形成上下文以后，进栈执行
- 第五步：执行完成以后，出栈，释放内存（闭包不会释放内存）

> 关于第四步进栈执行，在代码执行之前，要先做词法分析，然后变量提升，然后代码执行。如果代码中有函数，还要做很多其他的事情，比如初始化作用域链，形参赋值，初始化arguments，初始化this。下回我们再进行探讨。



#### 基础数据类型变量赋值

var a = 12经历了什么呢？

1. 创建值12，存储到栈内存中（基本数据类型存储到栈内存中，引用类型值是单独开辟一块新的内存堆内存）
2. 声明变量declare
3. 变量和值关联到一起

那么我们来分析一下上面的面试题：

1. 创建值12
2. 声明变量a
3. 将a和12关联到一起
4. 将b和12关联到一起
5. 创建值13
6. 将b和13关联到一起

所以基本类型的操作都是**按值操作**，因为它是直接存储到栈中



我们再来看看另外一道面试题：

```javascript
var a = { n:12 }
var b = a
b['n'] = 13
console.log(a.n) // 13
```

整个代码的执行过程和上面的面试题大体相同，只是在第四步进栈执行的过程稍有不同，因为数据类型不一样，创建值的过程不一样

创建值：

- 基本数据类型直接存储到栈

 + 引用数据类型
     + 单独开辟一块内存 Heap堆内存
     + 每一个堆内存都有一个16进制地址
     + 把键值对分别存储到堆中
     + 把16进制地址放到栈中存储：方便后期变量的关联
     + 所以，引用数据类型对变量的操作都是对堆内存地址的引用

> 在其他语言中可以通过方法获取内存地址，JS中没有暴露这个方法给开发者使用



所以，这道面试题的在形成上下文以后进栈代码执行过程为：

1. 开辟一个堆内存，假设地址为0x001
2. 把**键值对**存进这块堆内存中
3. 把内存地址存到栈内存中
4. 将a和这个地址关联
5. 将b和这个地址关联
6. b基于0x001这个地址找到堆内存，把堆内存中属性名为n的属性值改为13



> 不管是栈内存还是堆内存，都是浏览器从计算机中分配出来的内存，开辟的越多，电脑性能越慢，所以我们以后在JS性能优化方面，肯定会考虑到内存优化
>
> 栈内存：代码执行 & 存储基本类型值
>
> 堆内存：存储引用类型值